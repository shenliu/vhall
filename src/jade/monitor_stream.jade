//-
   Created by shen on 2016/5/24.

extends _main

block title
    title 流媒体服务实时监控系统

//- include _bootstrap

//- block prepend scripts
    +bootstrap

//- 引入 模态对话框
include _modal

block css
    link(rel="stylesheet", type="text/css", property='stylesheet', href="semantic/semantic.min.css")
    link(rel="stylesheet", type="text/css", property='stylesheet', href="css/3rd/jquery.dataTables.min.css")
    link(rel="stylesheet", type="text/css", property='stylesheet', href="css/3rd/fixedColumns.dataTables.min.css")
    link(rel="stylesheet", type="text/css", property='stylesheet', href="css/common.css")
    link(rel="stylesheet", type="text/css", property='stylesheet', href="css/monitor.css")

block content
    div.ui.main.container.raised.segment#container.vh-container
        h2(class="ui header")
            i(class="dashboard icon")
            div(class="content") 流状态监控

        table.ui.table.striped.celled.display.nowrap.compact.dataTable(cellspacing='0', width='100%')
            thead
                tr
                    th 流ID
                    th 流信息
                    th 第三方
                    th 直播助手
                    th SRS接收
                    th SRS分发
                    th HLS切片
                    th HLS同步
                    th HLS回放
                    th 移动
                    th Flash
                    th 卡顿用户数
                    th 用户总数
            tfoot
                tr
                    th 流ID
                    th 流信息
                    th 第三方
                    th 直播助手
                    th SRS接收
                    th SRS分发
                    th HLS切片
                    th HLS同步
                    th HLS回放
                    th 移动
                    th Flash
                    th 卡顿用户数
                    th 用户总数
            tbody

        +modal('vh-modal-list-details', '列表', true, false, true)
            include _tpl_monitor_list_details

        +modal('vh-modal-collect-details small', '列表', true, false, true)

        +modal('vh-modal-player', '播放', true, false, true)
            include _player

    script(src="scripts/3rd/require.js",defer="defer",async="async",data-main="scripts/monitor_stream")

    //- 每个td的list模版
    script(type="text/template" id="tpl_td_list").
        <div class="vh-error-list" data-id="<%- id %>" data-k="<%- k %>">
            <div class="ui list">
                <div class="item <%= row1.bg %>-bg">
                    <div class="header"><%- row1.code %> <%- row1.desc %></div>
                    <%- row1.date %>
                </div>
            </div>

            <div class="ui list">
                <% if (row2) { %>
                <div class="item <%= row2.bg %>-bg">
                    <div class="header"><%- row2.code %> <%- row2.desc %></div>
                    <%- row2.date %>
                </div>
                <% } else { %>
                <div class="item none-bg">
                    <div class="header">-</div>
                </div>
                <% } %>

                <% if (row3) { %>
                <div class="item <%= row3.bg %>-bg">
                    <div class="header"><%- row3.code %> <%- row3.desc %></div>
                    <%- row3.date %>
                </div>
                <% } else { %>
                    <div class="item none-bg">
                    <div class="header">-</div>
                </div>
                <% } %>
            </div>

            <div class="ui list">
                <div class="item vh-align-center">
                    <span style="color:#666;">最近错误数据 <%- errorNum %> 条</span>
                </div>
            </div>
        </div>



    //- 每个td的collect模版
    script(type="text/template" id="tpl_td_collect").
        <div class="vh-error-collect" data-id="<%- id %>" data-k="<%- k %>" data-type="<%- type %>">
            <h5 class="ui header">汇总: <%- sum %>/<%- total %></h5>
            <div class="ui list">
            <% _.each(items, function(item, idx) { %>
                <div class="item">
                    <div class="ui label">
                        <%- _.keys(item)[0] %>:
                        <div class="detail"><%- _.values(item)[0] %></div>
                    </div>
                </div>
            <% }); %>

            <% if (more) { %>
            <div class="ui accordion">
                <div class="title vh-more">more...</div>
                <div class="content">
                <% _.each(itemsRest, function(item, idx) { %>
                    <div class="item">
                        <div class="ui label">
                            <%- _.keys(item)[0] %>:
                            <div class="detail"><%- _.values(item)[0] %></div>
                        </div>
                    </div>
                <% }); %>
                </div>
            </div>
            <% } %>
            </div>
        </div>


    //- modal的list模版
    script(type="text/template" id="tpl_modal_list").
        <% _.each(items, function(item, idx) { %>
            <div class="item">
                <div class="content" style="width:100%;">
                    <div class="ui list">
                        <div class="item <%= item.bg %>">
                            <span><%- idx + 1 %>.</span>
                            <span>code:</span>
                            <span><%- item.code %></span>
                            <span><%- item.desc %></span>
                            <div class="vh-inline-block vh-float-right normalColor">
                                <i class="history link icon" title="历史" data-code="<%- item.code %>" data-id="<%- id %>" data-k="<%- k %>" />
                                <i class="setting link icon" title="操作" data-code="<%- item.code %>" data-id="<%- id %>" data-k="<%- k %>" />
                            </div>
                        </div>
                        <div class="item">
                            <span>p:</span>
                            <span><%- id %></span>
                        </div>
                        <div class="item">
                            <div>自定义:</div>
                            <div class="list">
                            <% _.mapObject(item.attr, function(val, key) { %>
                                <div class="item vh-long-span">
                                    <span><%- key %>:</span>
                                    <span><%- val %></span>
                                </div>
                            <% }); %>
                            </div>
                        </div>
                        <div class="item">
                            <span>时间:</span>
                            <span><%- item.date %></span>
                        </div>
                        <div class="item">
                            <span>主机:</span>
                            <span><%- item.hostname || "-"  %></span>
                        </div>
                    </div>
                </div>
            </div>
        <% }); %>

    //- modal的collect模版
    script(type="text/template" id="tpl_modal_collect").
        <h3 class="ui header">汇总: <%- sum %>/<%- total %></h3>
        <div class="ui list">
        <% _.each(items, function(item, idx) { %>
            <div class="item">
                <div class="ui label">
                <%- _.keys(item)[0] %>:
                    <div class="detail"><%- _.values(item)[0] %></div>
                </div>
            </div>
        <% }); %>
        </div>

    //- popup的history模版
    script(type="text/template" id="tpl_popup_history").
        <div class="ui list vh-history">
            <div class="item">
                <span>错误编号:</span>
                <span><%- errorCode %></span>
            </div>
            <div class="item">
                <span>活动历史:</span>
                <span><%- activeCode %></span>
            </div>
            <div class="item">
                <span>本机历史:</span>
                <span><%- localCode %></span>
            </div>
            <div class="item">
                <span>全部个数:</span>
                <span><%- all %></span>
            </div>
            <div class="item">
                <div>最近一周:</div>
                <div class="vh-history-graph"></div>
            </div>
        </div>

    //- popup的oper模版
    script(type="text/template" id="tpl_popup_oper").
        <div class="ui list vh-history">
            <div class="item">
                <span>错误编号:</span>
                <span><%- errorCode %></span>
            </div>
            <div class="item">
                <span>是否需要处理:</span>
                <span><%- needHandle %></span>
            </div>
            <div class="item">
                <div>详细说明及原因:</div>
                <div><%- reason %></div>
            </div>
            <div class="item">
                <div>处理方法:</div>
                <div><%- method %></div>
            </div>
        </div>
